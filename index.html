<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta name="viewport"
		content="width=device-width, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
	<link href="styles/styles.css" rel="stylesheet">
	
	<title>R4G</title>
	
	<!-- scripts for blockly code -->
	<script src="blockly/blockly_compressed.js"></script>
	<script src="blockly/blocks_compressed.js"></script>
	<script src="blockly/js/de.js"></script>
	<script src="blockly/javascript_compressed.js"></script>
</head>

<!-- body -->
<body ontouchstart="" id="body">
	<!-- ontouchstart="" enables low-delay CSS transitions. -->
	<table>	
		<tr>	<!-- Title, Logo and Program commands -->
			<h3>Robo4Girls</h3>
		<!--<img src="media/roberta.png" class="img-circle" style="float:center;width:100px;height:100px;"> -->
		<!-- buttons for program flow -->	
		</tr>
		<tr>
			<!-- Bluetooth communication -->
			<div class="bluetooth">
				<p>Verbinde dich mit deinem micro:bit über Bluetooth</p>
				<button id="connect" type="button">Verbinden</button>
				<button id="disconnect" type="button">Trennen</button>
			</div>
		</tr>
		<tr>
			<h4>Viel Spaß beim programmieren!</h4>
			<!-- play/stop button starts/stops blockly code execution -->
			<button id="start" onclick="handlePlay();" type="button">Start</button>
			<button id="stop" type="button">Stop</button>
			
			<!-- terminal, text color changes: debug=grey, input=blue, output=red -->
			<!-- <div class="term" id="terminal"></div> -->
			
			<!-- Area for blockly workspace -->
      <td id="blocklyArea">
      </td>
		</tr>
			<td>
					<button id="saveData" onclick="save()" type="mdl-button">Programm speichern</button>
					<button id="restoreData" onclick="restore()" type="button">Programm laden</button>
					<button id="endProgram" onclick=" end_program()" type="button">Programm Beenden</button>	
			</td>
	</table>

	<!-- script for bluetooth communication -->
	<script type="text/javascript" src="scripts/ble3.js"></script>

	<script>
		function handlePlay(event) {
			let delimiter_microbit = ":";
			Blockly.JavaScript.addReservedWords('code');
			var code = "Gb16" + delimiter_microbit + Blockly.JavaScript.workspaceToCode(Blockly.getMainWorkspace());
			var commands = code.split(delimiter_microbit);
			var max_length = 19;
			for(var i = 0; i < commands.length; i++){
				if(commands[i].length > max_length){
					commands[i]= commands[i].substring(0, max_length);
				}
				commands[i] += delimiter_microbit;
				console.log(commands[i]);
			}
			return sendData(commands);
		}

		function save(){
			console.log(localStorage);
			var eingabe = "";
			eingabe = prompt('Speichern unter:','');
			if(eingabe === ""){
				while(eingabe === ""){
					eingabe = prompt('Bitte Programm benennen:','');
				}
			}
			if(eingabe != null){
			var xmlDom = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
        	var xmlText = Blockly.Xml.domToPrettyText(xmlDom);
        	localStorage.setItem("R4G_" + eingabe, xmlText);
				alert("Programm '" + eingabe + "' gespeichert");  
			}
		}
		
		function restore() {	
			var storage_items = "";
			for (let i = 0; i < localStorage.length; i++) {
				if (localStorage.key(i).includes("R4G_")){
					let key_i = localStorage.key(i).replace("R4G_","");
					storage_items += key_i + "\n";
				}

			}
			if (storage_items === "") {
				alert("Keine gespeicherten Programme vorhanden");
				return 1;
			}
			var eingabe = prompt(storage_items + '\nProgramm laden:','');
			if(eingabe != null){
				if(eingabe === "" || !storage_items.includes(eingabe)){
					alert('Kein Programm mit Namen "' + eingabe + '" vorhanden');
					return 1;
				}
				workspace.clear();
				var xmlText = localStorage.getItem("R4G_" + eingabe);
				var xmlDom = Blockly.Xml.textToDom(xmlText);
				Blockly.Xml.domToWorkspace(xmlDom, Blockly.mainWorkspace);
				alert("Programm '"+ eingabe +"' wird geladen...");
			}
		}
		
		function end_program(){
			workspace.clear();
			onDisconnectButtonClick();
		}
	</script>
	
	<!-- blockly programming window -->
	<div id="blocklyDiv" style="position: absolute"></div>

	<!-- R4G blocks design -->
	<xml xmlns="http://www.w3.org/1999/xhtml" id="toolbox" style="display: none;">
		<!-- Category Movements -->
		<category name="Bewegungen" colour="#5b5ba5">
			<block type="forward">
				<field name="forward_duration">0.1</field>
			</block>	
			<block type="back">
				<field name="back_duration">0.1</field>
			</block>
			<block type="left">
				<field name="left_duration">0.1</field>
			</block>
			<block type="right">
				<field name="right_duration">0.1</field>
			</block>
			<block type="turn_left">
				<field name="turn_left_duration">0.1</field>
			</block>
			<block type="turn_right">
				<field name="turn_right_duration">0.1</field>
			</block>
		</category>
		<category name="Kombinationen" colour="#a55b6d">
			<block type="dance">
				<field name="repeat">1</field>
				<field name="intensity">sanft</field>
			</block>
			<block type="zigzag">
				<field name="repeat">1</field>
				<field name="intensity">sanft</field>
			</block>
			<block type="shake">
				<field name="repeat">1</field>
				<field name="intensity">sanft</field>
			</block>
			<block type="pirouette">
				<field name="repeat">1</field>
				<field name="direction">Links</field>
			</block>
		</category>
		<category name="Melodie" colour="#a55b5b">
			<block type="melody">
				<field name="melody">M1</field>
			</block>
		</category>
		<category name="Einstellungen" colour="#a5a55b">
			<block type="motor">
				<field name="motor">1</field>
				<field name="velocity">400</field>
			  </block>
		</category>
		<category name="LED-Anzeige" colour="#5ba593">
			<block type="show_text"></block>
			<block type="show_picture">
				<field name="pic">Wähle ein Bild</field>
				<field name="show_duration">1</field>
			</block>
		</category>
		<category name="Steuerung" colour="#5ba55b">
			<block type="repetition">
				<field name="repetition">1</field>
			</block>
		</category>
	</xml>
	
	<!-- Making Toolbox visible and resizable in Web-browser -->
	<script>
		var blocklyArea = document.getElementById('blocklyArea');
  	var blocklyDiv = document.getElementById('blocklyDiv');
		var workspace = Blockly.inject('blocklyDiv', {
			media: 'media/',
			toolbox: document.getElementById('toolbox')
		})
		var onresize = function(e) {
    // Compute the absolute coordinates and dimensions of blocklyArea.
    	var element = blocklyArea;
    	var x = 0;
    	var y = 0;
    	do {
      	x += element.offsetLeft;
      	y += element.offsetTop;
      	element = element.offsetParent;
    	} while (element);
    	// Position blocklyDiv over blocklyArea.
    	blocklyDiv.style.left = x + 'px';
    	blocklyDiv.style.top = y + 'px';
    	blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
    	blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
    	Blockly.svgResize(workspace);
  	};
		
  	window.addEventListener('resize', onresize, false);
  	onresize();
  	Blockly.svgResize(workspace);
		
		// An href with #key trigers an AJAX call to retrieve saved blocks.
		if ('BlocklyStorage' in window && window.location.hash.length > 1) {
      		BlocklyStorage.retrieveXml(window.location.hash.substring(1));
   	}
		
	</script>
	<!-- Blockly scripts -->
	<script src="scripts/R4Gblocks.js"></script>

</body>

</html>